name: æ„å»ºJaråŒ…å’ŒWindowså¯æ‰§è¡Œç¨‹åºï¼ˆç»ˆæç¨³å®šç‰ˆï¼‰

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  release:
    types: [ published ]

jobs:
  build:
    runs-on: windows-latest
    # æå‰å®šä¹‰å˜é‡ï¼Œç¡®ä¿å…¨æ­¥éª¤å¯è§
    env:
      JAR_FULL_PATH: "./target/SpigotPluginCreaterTool.jar"
      EXE_DIR: "./target/exe-win64"
      EXE_FULL_PATH: "./target/exe-win64/mc-plugin-tool.exe"
      LAUNCH4J_CONFIG: "./launch4j.xml"
      MAIN_CLASS: "org.bxwbb.spigotplugincreatertool.HelloApplication"
      TIMEOUT_SECONDS: 180  # 3åˆ†é’Ÿè¶…æ—¶
      # ç›´æ¥æŒ‡å®š64ä½Launch4jä¸‹è½½åœ°å€ï¼ˆé¿å…Chocolateyçš„32ä½ç‰ˆæœ¬ï¼‰
      LAUNCH4J_64_URL: "https://github.com/lukaszlenart/launch4j/releases/download/v3.14/launch4j-3.14-win64.zip"

    steps:
      - name: 1. æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: 2. è®¾ç½®64ä½JDK 21ï¼ˆéªŒè¯å¹¶è½¬ä¹‰JREè·¯å¾„ï¼‰
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
          architecture: x64
      - id: get_jre
        run: |
          # 1. ç¡®è®¤è¶…æ—¶å˜é‡æ˜¯å¦ç”Ÿæ•ˆï¼ˆå…³é”®æ’æŸ¥ï¼‰
          echo "âœ… è¶…æ—¶å˜é‡å€¼ï¼š${{ env.TIMEOUT_SECONDS }}"
          if (-not ${{ env.TIMEOUT_SECONDS }}) {
            echo "âŒ é”™è¯¯ï¼šè¶…æ—¶å˜é‡æœªä¼ é€’ï¼"
            exit 1
          }

          # 2. è·å–JREè·¯å¾„å¹¶è½¬ä¹‰ï¼ˆXMLä¸­éœ€ç”¨\\ä»£æ›¿\ï¼‰
          $jreRawPath = Join-Path $env:JAVA_HOME "jre"
          if (-not (Test-Path $jreRawPath)) {
            $jreRawPath = $env:JAVA_HOME  # æŸäº›JDKæ— ç‹¬ç«‹JREç›®å½•
          }
          $jreEscapedPath = $jreRawPath -replace "\\", "\\\\"  # è½¬ä¹‰ä¸ºXMLå…¼å®¹æ ¼å¼ï¼ˆC:\\...ï¼‰
          echo "âœ… åŸå§‹JREè·¯å¾„ï¼š$jreRawPath"
          echo "âœ… XMLè½¬ä¹‰åè·¯å¾„ï¼š$jreEscapedPath"
          echo "jre_escaped=$jreEscapedPath" >> $env:GITHUB_OUTPUT

          # 3. éªŒè¯JREæœ‰æ•ˆæ€§ï¼ˆç¡®ä¿èƒ½æ‰¾åˆ°java.exeï¼‰
          $javaExe = Join-Path $jreRawPath "bin\java.exe"
          if (Test-Path $javaExe) {
            echo "âœ… Java.exeå­˜åœ¨ï¼š$javaExe"
            & $javaExe -version  # éªŒè¯Javaå¯è¿è¡Œ
          } else {
            echo "âŒ é”™è¯¯ï¼šJREè·¯å¾„ä¸‹æ— java.exeï¼"
            exit 1
          }
        shell: pwsh

      - name: 3. æ„å»ºJaråŒ…ï¼ˆæœ€ç»ˆéªŒè¯ï¼‰
        run: |
          mvn clean package -DskipTests -U
          # éªŒè¯JaråŒ…å’Œä¸»ç±»
          if (-not (Test-Path "${{ env.JAR_FULL_PATH }}")) {
            echo "âŒ JaråŒ…ä¸å­˜åœ¨ï¼"
            exit 1
          }
          $mainClassInJar = "${{ env.MAIN_CLASS }}".Replace('.', '/') + ".class"
          if (-not (jar tf "${{ env.JAR_FULL_PATH }}" | Select-String -Pattern "$mainClassInJar")) {
            echo "âŒ ä¸»ç±»ä¸åœ¨JaråŒ…ä¸­ï¼"
            exit 1
          }
          echo "âœ… JaråŒ…éªŒè¯é€šè¿‡ï¼ˆå¤§å°ï¼š$(Get-Item "${{ env.JAR_FULL_PATH }}").Length å­—èŠ‚ï¼‰"
        shell: pwsh

      - name: 4. å®‰è£…64ä½Launch4jï¼ˆå½»åº•è§£å†³32/64å…¼å®¹é—®é¢˜ï¼‰
        id: get_launch4j
        run: |
          echo "=== ä¸‹è½½64ä½Launch4j ==="
          Invoke-WebRequest -Uri "${{ env.LAUNCH4J_64_URL }}" -OutFile "./launch4j.zip"
          
          echo "=== è§£å‹åˆ°æŒ‡å®šç›®å½• ==="
          Expand-Archive -Path "./launch4j.zip" -DestinationPath "./launch4j-64" -Force
          $launch4jPath = "./launch4j-64/launch4j.exe"
          
          # éªŒè¯64ä½å·¥å…·
          if (Test-Path $launch4jPath) {
            echo "âœ… 64ä½Launch4jè·¯å¾„ï¼š$launch4jPath"
            & $launch4jPath --version  # è¾“å‡ºç‰ˆæœ¬ç¡®è®¤
            echo "launch4j_path=$launch4jPath" >> $env:GITHUB_OUTPUT
          } else {
            echo "âŒ é”™è¯¯ï¼š64ä½Launch4jè§£å‹å¤±è´¥ï¼"
            exit 1
          }
        shell: pwsh

      - name: 5. ç”ŸæˆXMLé…ç½®ï¼ˆç¡®ä¿è½¬ä¹‰æ­£ç¡®ï¼‰
        run: |
          # ç”ŸæˆXMLæ—¶ï¼Œæ‰€æœ‰è·¯å¾„å‡ç”¨è½¬ä¹‰åçš„æ ¼å¼ï¼ˆé¿å…è§£æé”™è¯¯ï¼‰
          $config = @"
          <?xml version="1.0" encoding="UTF-8"?>
          <launch4jConfig>
            <dontWrapJar>false</dontWrapJar>
            <jarPath>${{ env.JAR_FULL_PATH }}</jarPath>  <!-- ç›¸å¯¹è·¯å¾„æ— éœ€è½¬ä¹‰ -->
            <outfile>${{ env.EXE_FULL_PATH }}</outfile>
            <platform>win64</platform>
            <!-- JREè·¯å¾„å·²è½¬ä¹‰ï¼ˆC:\\...ï¼‰ï¼ŒXMLå¯æ­£å¸¸è§£æ -->
            <jre>
              <path>${{ steps.get_jre.outputs.jre_escaped }}</path>
              <minVersion>21</minVersion>
              <maxVersion>21</maxVersion>  <!-- é™åˆ¶JREç‰ˆæœ¬ï¼Œé¿å…å…¼å®¹é—®é¢˜ -->
            </jre>
            <mainClass>${{ env.MAIN_CLASS }}</mainClass>
            <!-- å…³é—­ä¸å¿…è¦çš„åŠŸèƒ½ï¼Œå‡å°‘å¤„ç†è´Ÿæ‹… -->
            <manifest></manifest>
            <classPath></classPath>
          </launch4jConfig>
          "@
          # å†™å…¥å¹¶éªŒè¯é…ç½®
          $config | Set-Content "${{ env.LAUNCH4J_CONFIG }}" -Encoding UTF8
          echo "âœ… ç”Ÿæˆæœ€ç»ˆé…ç½®æ–‡ä»¶ï¼ˆè½¬ä¹‰å·²å¤„ç†ï¼‰ï¼š"
          Get-Content "${{ env.LAUNCH4J_CONFIG }}" -Encoding UTF8
          # é¢å¤–æ£€æŸ¥XMLè¯­æ³•ï¼ˆé¿å…æ ‡ç­¾æœªé—­åˆï¼‰
          if ($config -match '<launch4jConfig>.*?</launch4jConfig>' -and $config -notmatch '<[^/]+></[^>]+>') {
            echo "âœ… XMLè¯­æ³•åˆæ­¥éªŒè¯é€šè¿‡"
          } else {
            echo "âŒ é”™è¯¯ï¼šXMLé…ç½®è¯­æ³•å¼‚å¸¸ï¼"
            exit 1
          }
        shell: pwsh

      - name: 6. ç”ŸæˆEXEï¼ˆè¶…æ—¶ä¿®å¤+å®æ—¶ç›‘æ§ï¼‰
        run: |
          $launch4j = "${{ steps.get_launch4j.outputs.launch4j_path }}"
          $timeout = [int]${{ env.TIMEOUT_SECONDS }}  # å¼ºåˆ¶è½¬ä¸ºæ•´æ•°ï¼Œé¿å…è§£æé—®é¢˜
          $elapsed = 0

          echo "=== å¯åŠ¨64ä½Launch4jï¼ˆè¶…æ—¶ï¼š$timeoutç§’ï¼‰ ==="
          # å¯åŠ¨è¿›ç¨‹å¹¶æ•è·åŒè¾“å‡ºæµ
          $process = Start-Process -FilePath $launch4j `
            -ArgumentList "${{ env.LAUNCH4J_CONFIG }}" `
            -NoNewWindow `
            -PassThru `
            -RedirectStandardOutput "./out.log" `
            -RedirectStandardError "./err.log"

          # å®æ—¶ç›‘æ§ï¼ˆæ¯5ç§’ä¸€æ¬¡ï¼Œæ›´çµæ•ï¼‰
          while (-not $process.HasExited -and $elapsed -lt $timeout) {
            Start-Sleep -Seconds 5
            $elapsed += 5
            $remaining = $timeout - $elapsed
            # è·å–èµ„æºå ç”¨ï¼ˆå¤„ç†å¯èƒ½çš„è®¡æ•°å™¨ä¸å­˜åœ¨é—®é¢˜ï¼‰
            $cpu = (Get-Counter "\Process(launch4j*)\% Processor Time" -ErrorAction SilentlyContinue).CounterSamples.CookedValue
            $mem = (Get-Counter "\Process(launch4j*)\Working Set - Private" -ErrorAction SilentlyContinue).CounterSamples.CookedValue / 1MB
            echo "å·²è¿è¡Œ$elapsedç§’ | å‰©ä½™$remainingç§’ | CPU: $($cpu.ToString('N2'))% | å†…å­˜: $($mem.ToString('N2'))MB"
          }

          # ç»“æœå¤„ç†
          if (-not $process.HasExited) {
            echo "`nâŒ è¶…æ—¶ï¼å¼ºåˆ¶ç»ˆæ­¢è¿›ç¨‹"
            $process | Stop-Process -Force
            exit 1
          } else {
            echo "`nâœ… Launch4jæ­£å¸¸é€€å‡ºï¼ˆç ï¼š$($process.ExitCode)ï¼‰"
            echo "`næ ‡å‡†è¾“å‡ºï¼š"
            Get-Content "./out.log"
            echo "`né”™è¯¯è¾“å‡ºï¼š"
            Get-Content "./err.log"
            if ($process.ExitCode -ne 0) { exit 1 }
          }

          # æœ€ç»ˆéªŒè¯EXE
          if (Test-Path "${{ env.EXE_FULL_PATH }}") {
            echo "`nğŸ‰ 64ä½EXEç”ŸæˆæˆåŠŸï¼è·¯å¾„ï¼š${{ env.EXE_FULL_PATH }}"
            echo "EXEå¤§å°ï¼š$(Get-Item "${{ env.EXE_FULL_PATH }}").Length å­—èŠ‚"
          } else {
            echo "`nâŒ EXEæœªç”Ÿæˆï¼"
            exit 1
          }
        shell: pwsh

      - name: 7. ä¸Šä¼ æœ€ç»ˆäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: mc-plugin-tool-final
          path: |
            ${{ env.JAR_FULL_PATH }}
            ${{ env.EXE_FULL_PATH }}