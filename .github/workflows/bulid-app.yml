name: 构建Jar包和Windows可执行程序

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  release:
    types: [ published ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      - name: 设置JDK 21（64位）
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: 构建可执行Jar包
        run: mvn clean package -DskipTests -U
        shell: pwsh

      - name: 安装Launch4j
        run: |
          choco install launch4j -y
          echo "Launch4j安装完成，开始搜索实际路径..."
        shell: pwsh

      - name: 搜索launch4j.exe实际路径
        id: find_launch4j
        run: |
          # 搜索常见安装目录（覆盖Program Files和Chocolatey可能的路径）
          $possiblePaths = @(
            "C:\Program Files\launch4j\launch4j.exe",
            "C:\Program Files (x86)\launch4j\launch4j.exe",
            "C:\ProgramData\chocolatey\bin\launch4j.exe",
            "C:\tools\launch4j\launch4j.exe"
          )
          
          # 遍历可能的路径，找到存在的文件
          $foundPath = $null
          foreach ($path in $possiblePaths) {
            if (Test-Path $path) {
              $foundPath = $path
              break
            }
          }
          
          # 如果没找到，全局搜索（耗时但确保覆盖）
          if (-not $foundPath) {
            echo "未在常见路径找到，开始全局搜索..."
            $searchResult = Get-ChildItem -Path C:\ -Filter launch4j.exe -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($searchResult) {
              $foundPath = $searchResult.FullName
            }
          }
          
          # 输出结果并设置为步骤变量（供后续步骤使用）
          if ($foundPath) {
            echo "找到launch4j.exe: $foundPath"
            echo "launch4j_path=$foundPath" >> $env:GITHUB_OUTPUT
          } else {
            echo "错误：未找到launch4j.exe"
            exit 1
          }
        shell: pwsh

      - name: 验证Launch4j路径有效性
        run: |
          $launch4jPath = "${{ steps.find_launch4j.outputs.launch4j_path }}"
          echo "验证路径: $launch4jPath"
          if (-not (Test-Path $launch4jPath)) {
            echo "错误：路径不存在"
            exit 1
          }
          # 验证可执行性（输出版本）
          & $launch4jPath --version
        shell: pwsh

      - name: 创建EXE输出目录
        run: |
          New-Item -ItemType Directory -Path ./target/exe-win64 -Force
        shell: pwsh

      - name: 生成Windows 64位EXE程序（使用搜索到的路径）
        run: |
          $launch4jPath = "${{ steps.find_launch4j.outputs.launch4j_path }}"
          echo "使用路径生成EXE: $launch4jPath"
          & $launch4jPath ./launch4j.xml
        shell: pwsh

      - name: 上传Jar包产物
        uses: actions/upload-artifact@v4
        with:
          name: mc-plugin-tool-jar
          path: ./target/*.jar

      - name: 上传Windows EXE产物
        uses: actions/upload-artifact@v4
        with:
          name: mc-plugin-tool-windows
          path: ./target/exe-win64/*.exe