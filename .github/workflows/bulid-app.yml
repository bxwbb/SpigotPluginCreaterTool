name: æ„å»ºJaråŒ…å’ŒWindowså¯æ‰§è¡Œç¨‹åºï¼ˆå®˜æ–¹64ä½Launch4jç‰ˆï¼‰

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  release:
    types: [ published ]

jobs:
  build:
    runs-on: windows-latest
    env:
      JAR_FULL_PATH: "./target/SpigotPluginCreaterTool.jar"
      EXE_DIR: "./target/exe-win64"
      EXE_FULL_PATH: "./target/exe-win64/mc-plugin-tool.exe"
      LAUNCH4J_CONFIG: "./launch4j.xml"
      MAIN_CLASS: "org.bxwbb.spigotplugincreatertool.HelloApplication"
      TIMEOUT_SECONDS: 180
      # å®˜æ–¹64ä½Launch4jä¸‹è½½åœ°å€ï¼ˆSourceForgeï¼Œç¨³å®šæœ‰æ•ˆï¼‰
      LAUNCH4J_64_EXE_URL: "https://downloads.sourceforge.net/project/launch4j/launch4j-3/3.14/launch4j-3.14-win64.exe"

    steps:
      - name: 1. æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: 2. è®¾ç½®64ä½JDK 21ï¼ˆéªŒè¯JREè·¯å¾„ï¼‰
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
          architecture: x64
      - id: get_jre
        run: |
          # éªŒè¯è¶…æ—¶å˜é‡
          echo "âœ… è¶…æ—¶æ—¶é—´ï¼š${{ env.TIMEOUT_SECONDS }}ç§’"
          if (-not ${{ env.TIMEOUT_SECONDS }}) { exit 1 }

          # è·å–å¹¶è½¬ä¹‰JREè·¯å¾„ï¼ˆXMLå…¼å®¹ï¼‰
          $jreRaw = if (Test-Path "$env:JAVA_HOME/jre") { "$env:JAVA_HOME/jre" } else { "$env:JAVA_HOME" }
          $jreEscaped = $jreRaw -replace "\\", "\\\\"  # è½¬ä¹‰ä¸ºC:\\...
          echo "jre_escaped=$jreEscaped" >> $env:GITHUB_OUTPUT
          echo "âœ… JREè·¯å¾„ï¼ˆè½¬ä¹‰åï¼‰ï¼š$jreEscaped"

          # éªŒè¯Javaæœ‰æ•ˆæ€§
          & "$jreRaw/bin/java.exe" -version
        shell: pwsh

      - name: 3. æ„å»ºJaråŒ…
        run: |
          mvn clean package -DskipTests -U
          if (-not (Test-Path "${{ env.JAR_FULL_PATH }}")) { exit 1 }
          $mainClassInJar = "${{ env.MAIN_CLASS }}".Replace('.', '/') + ".class"
          if (-not (jar tf "${{ env.JAR_FULL_PATH }}" | Select-String $mainClassInJar)) { exit 1 }
          echo "âœ… JaråŒ…éªŒè¯é€šè¿‡"
        shell: pwsh

      - name: 4. å®‰è£…å®˜æ–¹64ä½Launch4jï¼ˆé™é»˜æ¨¡å¼ï¼‰
        id: get_launch4j
        run: |
          echo "=== ä¸‹è½½å®˜æ–¹64ä½Launch4j ==="
          # ä½¿ç”¨Invoke-WebRequestä¸‹è½½ï¼Œæ·»åŠ è¶…æ—¶é‡è¯•
          Invoke-WebRequest -Uri "${{ env.LAUNCH4J_64_EXE_URL }}" `
            -OutFile "./launch4j-64.exe" `
            -TimeoutSec 60 `
            -MaximumRetryCount 3 `
            -RetryIntervalSec 5

          echo "=== é™é»˜å®‰è£…ï¼ˆæ— äº¤äº’ï¼‰ ==="
          # /S æ˜¯é™é»˜å®‰è£…å‚æ•°ï¼Œå®‰è£…åˆ°é»˜è®¤ç›®å½•C:\Program Files\launch4j
          Start-Process -FilePath "./launch4j-64.exe" -ArgumentList "/S" -Wait -NoNewWindow

          echo "=== éªŒè¯å®‰è£… ==="
          $launch4jPath = "C:\Program Files\launch4j\launch4j.exe"
          if (Test-Path $launch4jPath) {
            echo "âœ… 64ä½Launch4jè·¯å¾„ï¼š$launch4jPath"
            & $launch4jPath --version  # è¾“å‡ºç‰ˆæœ¬ç¡®è®¤
            echo "launch4j_path=$launch4jPath" >> $env:GITHUB_OUTPUT
          } else {
            echo "âŒ å®‰è£…å¤±è´¥ï¼æœç´¢å¯èƒ½è·¯å¾„ï¼š"
            Get-ChildItem -Path C:\ -Filter "launch4j.exe" -Recurse -Depth 3 | Select-Object FullName
            exit 1
          }
        shell: pwsh

      - name: 5. ç”ŸæˆXMLé…ç½®ï¼ˆè½¬ä¹‰æ­£ç¡®ï¼‰
        run: |
          $config = @"
          <?xml version="1.0" encoding="UTF-8"?>
          <launch4jConfig>
            <dontWrapJar>false</dontWrapJar>
            <jarPath>${{ env.JAR_FULL_PATH }}</jarPath>
            <outfile>${{ env.EXE_FULL_PATH }}</outfile>
            <platform>win64</platform>
            <jre>
              <path>${{ steps.get_jre.outputs.jre_escaped }}</path>
              <minVersion>21</minVersion>
              <maxVersion>21</maxVersion>
            </jre>
            <mainClass>${{ env.MAIN_CLASS }}</mainClass>
          </launch4jConfig>
          "@
          $config | Set-Content "${{ env.LAUNCH4J_CONFIG }}" -Encoding UTF8
          echo "âœ… é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
        shell: pwsh

      - name: 6. ç”ŸæˆEXEï¼ˆè¶…æ—¶ç›‘æ§ï¼‰
        run: |
          $launch4j = "${{ steps.get_launch4j.outputs.launch4j_path }}"
          $timeout = [int]${{ env.TIMEOUT_SECONDS }}
          $elapsed = 0

          # å¯åŠ¨ç”Ÿæˆ
          $process = Start-Process -FilePath $launch4j `
            -ArgumentList "${{ env.LAUNCH4J_CONFIG }}" `
            -NoNewWindow -PassThru `
            -RedirectStandardOutput "./out.log" `
            -RedirectStandardError "./err.log"

          # ç›‘æ§è¿›ç¨‹
          while (-not $process.HasExited -and $elapsed -lt $timeout) {
            Start-Sleep 5
            $elapsed += 5
            $remaining = $timeout - $elapsed
            $cpu = (Get-Counter "\Process(launch4j*)\% Processor Time" -ErrorAction SilentlyContinue).CounterSamples.CookedValue
            $mem = (Get-Counter "\Process(launch4j*)\Working Set - Private" -ErrorAction SilentlyContinue).CounterSamples.CookedValue / 1MB
            echo "å·²è¿è¡Œ$elapsedç§’ | å‰©ä½™$remainingç§’ | CPU: $($cpu.ToString('N2'))% | å†…å­˜: $($mem.ToString('N2'))MB"
          }

          # ç»“æœå¤„ç†
          if (-not $process.HasExited) {
            $process | Stop-Process -Force
            echo "âŒ è¶…æ—¶ç»ˆæ­¢"
            exit 1
          } else {
            echo "`né€€å‡ºç ï¼š$($process.ExitCode)"
            echo "æ ‡å‡†è¾“å‡ºï¼š$(Get-Content ./out.log)"
            echo "é”™è¯¯è¾“å‡ºï¼š$(Get-Content ./err.log)"
            if ($process.ExitCode -ne 0) { exit 1 }
          }

          # éªŒè¯EXE
          if (Test-Path "${{ env.EXE_FULL_PATH }}") {
            echo "`nğŸ‰ EXEç”ŸæˆæˆåŠŸï¼è·¯å¾„ï¼š${{ env.EXE_FULL_PATH }}"
          } else {
            echo "âŒ EXEæœªç”Ÿæˆ"
            exit 1
          }
        shell: pwsh

      - name: 7. ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: mc-plugin-tool-final
          path: |
            ${{ env.JAR_FULL_PATH }}
            ${{ env.EXE_FULL_PATH }}