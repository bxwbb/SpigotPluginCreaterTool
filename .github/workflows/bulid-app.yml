name: Build JavaFX (Jar & EXE with JDK 21)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    env:
      JAVAFX_MODULES: "javafx.controls,javafx.fxml,javafx.base,javafx.graphics"

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn -B clean package

      - name: 定位生成的JAR文件
        id: find_jar
        run: |
          $jarFile = Get-ChildItem -Path target -Filter *.jar | 
                    Where-Object { $_.Name -notmatch "sources|javadoc" } | 
                    Select-Object -First 1
          if (-not $jarFile) {
            throw "未找到生成的JAR文件，请检查Maven配置"
          }
          echo "jar_path=$($jarFile.FullName)" >> $env:GITHUB_OUTPUT
          echo "jar_name=$($jarFile.Name)" >> $env:GITHUB_OUTPUT
          echo "app_name=$($jarFile.Name -replace '\.jar$', '')" >> $env:GITHUB_OUTPUT

      - name: 使用jpackage生成EXE（添加JavaFX模块路径）
        run: |
          $appName = "${{ steps.find_jar.outputs.app_name }}"
          $jarName = "${{ steps.find_jar.outputs.jar_name }}"
          $mainClass = "org.bxwbb.spigotplugincreatertool.HelloApplication"  # 替换为你的主类

          # 创建输出目录
          New-Item -ItemType Directory -Path target/exe-dist -Force

          # 定位JavaFX jmods路径（Maven仓库中）
          $javafxVersion = "21.0.2"
          $javafxBaseJmodPath = "$env:USERPROFILE\.m2\repository\org\openjfx\javafx-base\$javafxVersion\javafx-base-$javafxVersion-win.jmod"
          $javafxJmodsDir = Split-Path $javafxBaseJmodPath -Parent  # 获取jmods所在目录

          # 合并JDK模块路径和JavaFX模块路径（Windows用分号分隔）
          $modulePath = "${env:JAVA_HOME}\jmods;$javafxJmodsDir"

          # 执行jpackage，指定正确的模块路径
          jpackage `
            --type exe `
            --input "target" `
            --main-jar "$jarName" `
            --main-class "$mainClass" `
            --name "$appName" `
            --dest "target/exe-dist" `
            --module-path "$modulePath" `  # 关键：包含JDK和JavaFX模块
            --add-modules ${{ env.JAVAFX_MODULES }} `
            --win-console `
            --app-version "1.0.0" `
            --copyright "BXWBB"

      - name: 上传JAR产物
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.find_jar.outputs.app_name }}-jar
          path: ${{ steps.find_jar.outputs.jar_path }}
          retention-days: 14

      - name: 上传EXE产物
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.find_jar.outputs.app_name }}-exe
          path: target/exe-dist/*.exe
          retention-days: 14