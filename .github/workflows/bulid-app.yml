name: 构建Jar包和Windows可执行程序（最终稳定版）

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  release:
    types: [ published ]

jobs:
  build:
    runs-on: windows-latest
    env:
      JAR_FULL_PATH: "./target/SpigotPluginCreaterTool-0.0.1.jar"
      EXE_DIR: "./target/exe-win64"
      EXE_FULL_PATH: "./target/exe-win64/我的世界spigot插件图形化开发工具.exe"
      LAUNCH4J_CONFIG: "./launch4j.xml"

    steps:
      - name: 1. 拉取仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - run: |
          echo "=== 确认核心文件存在 ==="
          # 只检查关键文件是否存在，不做冗余校验
          if (-not (Test-Path "${{ env.LAUNCH4J_CONFIG }}")) {
            echo "❌ 错误：launch4j.xml不存在！请放在仓库根目录"
            exit 1
          }
          echo "✅ launch4j.xml已找到"
        shell: pwsh

      - name: 2. 设置JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      - run: java -version  # 快速验证Java环境
        shell: pwsh

      - name: 3. 构建Jar包
        run: |
          echo "=== 开始Maven打包 ==="
          mvn clean package -DskipTests -U
          
          # 验证Jar包是否生成
          if (-not (Test-Path "${{ env.JAR_FULL_PATH }}")) {
            echo "❌ 错误：Jar包未生成！检查Maven配置"
            echo "target目录内容："
            Get-ChildItem ./target | Select-Object Name
            exit 1
          }
          echo "✅ Jar包生成成功：${{ env.JAR_FULL_PATH }}"
        shell: pwsh

      - name: 4. 安装并快速定位Launch4j
        id: find_launch4j
        run: |
          echo "=== 安装Launch4j ==="
          choco install launch4j -y
          
          # 优先搜索高概率路径（秒级完成）
          $fastPaths = @(
            "C:\Program Files\launch4j\launch4j.exe",
            "C:\ProgramData\chocolatey\lib\launch4j\tools\launch4j.exe",
            "C:\Program Files (x86)\launch4j\launch4j.exe"
          )
          $foundPath = $fastPaths | Where-Object { Test-Path $_ } | Select-Object -First 1
          
          if (-not $foundPath) {
            echo "⚠️  快速路径未找到，搜索Chocolatey bin目录"
            $foundPath = Get-ChildItem -Path "C:\ProgramData\chocolatey\bin\" -Filter "launch4j.exe" | Select-Object -First 1
            if ($foundPath) { $foundPath = $foundPath.FullName }
          }
          
          if (-not $foundPath) {
            echo "❌ 错误：未找到launch4j.exe"
            exit 1
          }
          
          echo "✅ Launch4j路径：$foundPath"
          echo "launch4j_path=$foundPath" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: 5. 生成Windows EXE
        run: |
          $launch4jPath = "${{ steps.find_launch4j.outputs.launch4j_path }}"
          echo "=== 生成EXE ==="
          
          # 创建输出目录
          New-Item -ItemType Directory -Path "${{ env.EXE_DIR }}" -Force | Out-Null
          
          # 执行生成命令（捕获详细错误）
          & $launch4jPath "${{ env.LAUNCH4J_CONFIG }}"
          if ($LASTEXITCODE -ne 0) {
            echo "❌ EXE生成失败！Launch4j退出码：$LASTEXITCODE"
            echo "可能原因：Jar包路径错误/主类不存在/JRE版本不匹配"
            exit 1
          }
          
          # 验证EXE是否生成
          if (-not (Test-Path "${{ env.EXE_FULL_PATH }}")) {
            echo "❌ 错误：EXE文件未找到！"
            exit 1
          }
          echo "✅ EXE生成成功：${{ env.EXE_FULL_PATH }}"
        shell: pwsh

      - name: 6. 上传产物
        run: echo "=== 开始上传产物 ==="
        shell: pwsh

      - name: 上传Jar包
        uses: actions/upload-artifact@v4
        with:
          name: mc-plugin-tool-jar
          path: ${{ env.JAR_FULL_PATH }}
          if-no-files-found: error

      - name: 上传Windows EXE
        uses: actions/upload-artifact@v4
        with:
          name: mc-plugin-tool-windows
          path: ${{ env.EXE_FULL_PATH }}
          if-no-files-found: error