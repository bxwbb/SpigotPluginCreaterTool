name: 构建Jar包和Windows可执行程序

# 触发条件：main分支的push、PR，以及发布事件
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  release:
    types: [ published ]

jobs:
  build:
    runs-on: windows-latest  # 使用Windows环境构建EXE

    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      - name: 设置JDK 21（64位）
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'  # 使用Eclipse Temurin JDK
          cache: maven  # 缓存Maven依赖，加速后续构建

      - name: 构建可执行Jar包（强制更新依赖）
        run: mvn clean package -DskipTests -U
        # 说明：
        # - 生成的Jar包路径由pom.xml的<build><finalName>控制，默认在target/目录
        # - 需确保生成的主Jar包名称与后续launch4j配置中的jarPath匹配

      - name: 安装Launch4j（Java转EXE工具）
        run: |
          # 使用Chocolatey（Windows包管理器）安装launch4j
          # GitHub的windows-latest环境预装了Chocolatey，无需额外配置
          choco install launch4j -y
        shell: pwsh  # 使用PowerShell执行命令

      - name: 创建EXE输出目录
        run: |
          # 确保输出目录存在（与后续EXE生成路径和上传路径一致）
          New-Item -ItemType Directory -Path ./target/exe-win64 -Force
        shell: pwsh

      - name: 生成Windows 64位EXE程序
        run: |
          # 使用launch4j根据配置文件生成EXE
          # 需确保项目根目录存在launch4j.xml配置文件（见下方说明）
          launch4j ./launch4j.xml
        shell: pwsh

      - name: 上传Jar包产物
        uses: actions/upload-artifact@v4
        with:
          name: mc-plugin-tool-jar
          path: ./target/*.jar  # 上传target目录下所有Jar文件

      - name: 上传Windows EXE产物
        uses: actions/upload-artifact@v4
        with:
          name: mc-plugin-tool-windows
          path: ./target/exe-win64/*.exe  # 上传生成的EXE文件