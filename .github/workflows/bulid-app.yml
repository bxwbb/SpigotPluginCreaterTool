name: æ„å»ºJaråŒ…å’ŒWindowså¯æ‰§è¡Œç¨‹åºï¼ˆæ–‡ä»¶å®Œæ•´æ€§æ ¡éªŒç‰ˆï¼‰

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  release:
    types: [ published ]

jobs:
  build:
    runs-on: windows-latest
    env:
      JAR_FULL_PATH: "./target/SpigotPluginCreaterTool.jar"
      EXE_DIR: "./target/exe-win64"
      EXE_FULL_PATH: "./target/exe-win64/mc-plugin-tool.exe"
      LAUNCH4J_CONFIG: "./launch4j.xml"
      MAIN_CLASS: "org.bxwbb.spigotplugincreatertool.HelloApplication"
      TIMEOUT_SECONDS: 180
      # å…³é”®é…ç½®ï¼šå®˜æ–¹64ä½å®‰è£…åŒ…ä¿¡æ¯ï¼ˆå«SHA256å“ˆå¸Œï¼Œç¡®ä¿å®Œæ•´æ€§ï¼‰
      LAUNCH4J_64_URL: "https://downloads.sourceforge.net/project/launch4j/launch4j-3/3.14/launch4j-3.14-win64.exe"
      LAUNCH4J_64_SHA256: "A6A344B8F64B6C7B8D1E7F2G3H4I5J6K7L8M9N0O1P2Q3R4S5T6U7V8W9X0Y1Z2"  # æ›¿æ¢ä¸ºå®˜æ–¹å“ˆå¸Œï¼ˆè§ä¸‹æ–¹è¯´æ˜ï¼‰
      LAUNCH4J_EXE_PATH: "./launch4j-64.exe"

    steps:
      - name: 1. æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: 2. è®¾ç½®64ä½JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
          architecture: x64
      - id: get_jre
        run: |
          $jreRaw = if (Test-Path "$env:JAVA_HOME/jre") { "$env:JAVA_HOME/jre" } else { "$env:JAVA_HOME" }
          $jreEscaped = $jreRaw -replace "\\", "\\\\"
          echo "jre_escaped=$jreEscaped" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: 3. æ„å»ºJaråŒ…
        run: |
          mvn clean package -DskipTests -U
          if (-not (Test-Path "${{ env.JAR_FULL_PATH }}") -or (Get-Item "${{ env.JAR_FULL_PATH }}").Length -lt 1024) { exit 1 }
          $mainClassInJar = "${{ env.MAIN_CLASS }}".Replace('.', '/') + ".class"
          if (-not (jar tf "${{ env.JAR_FULL_PATH }}" | Select-String $mainClassInJar)) { exit 1 }
        shell: pwsh

      - name: 4. ä¸‹è½½å¹¶æ ¡éªŒ64ä½Launch4jï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
        id: download_launch4j
        run: |
          echo "=== 1. ç”¨curlä¸‹è½½ï¼ˆæ›´ç¨³å®šï¼‰ ==="
          # æ”¹ç”¨curlä¸‹è½½ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼Œæ¯”Invoke-WebRequestæ›´æŠ—ç½‘ç»œæ³¢åŠ¨
          curl -L -f -o "${{ env.LAUNCH4J_EXE_PATH }}" "${{ env.LAUNCH4J_64_URL }}" `
            --retry 5 --retry-delay 3 --connect-timeout 30
          # å‚æ•°è¯´æ˜ï¼š-Lè·Ÿéšé‡å®šå‘ï¼Œ-få¤±è´¥æŠ¥é”™ï¼Œ--retryé‡è¯•5æ¬¡ï¼Œ--retry-delayé—´éš”3ç§’

          echo "`n=== 2. éªŒè¯æ–‡ä»¶å­˜åœ¨æ€§ ==="
          if (-not (Test-Path "${{ env.LAUNCH4J_EXE_PATH }}")) {
            echo "âŒ é”™è¯¯ï¼šå®‰è£…åŒ…æœªä¸‹è½½æˆåŠŸï¼"
            exit 1
          }
          $fileSize = (Get-Item "${{ env.LAUNCH4J_EXE_PATH }}").Length / 1MB
          echo "âœ… å®‰è£…åŒ…å¤§å°ï¼š$fileSize MBï¼ˆæ­£å¸¸çº¦8.4MBï¼‰"
          if ($fileSize -lt 8) {  # è‹¥å°äº8MBï¼Œåˆ¤å®šä¸ºä¸å®Œæ•´
            echo "âŒ é”™è¯¯ï¼šå®‰è£…åŒ…è¿‡å°ï¼Œå¯èƒ½æŸåï¼"
            exit 1
          }

          echo "`n=== 3. å®˜æ–¹å“ˆå¸Œæ ¡éªŒï¼ˆç¡®ä¿å®Œæ•´æ€§ï¼‰ ==="
          # è®¡ç®—ä¸‹è½½æ–‡ä»¶çš„SHA256å“ˆå¸Œ
          $downloadedHash = (Get-FileHash -Path "${{ env.LAUNCH4J_EXE_PATH }}" -Algorithm SHA256).Hash.ToUpper()
          $officialHash = "${{ env.LAUNCH4J_64_SHA256 }}".ToUpper()
          echo "ä¸‹è½½æ–‡ä»¶å“ˆå¸Œï¼š$downloadedHash"
          echo "å®˜æ–¹æ ‡å‡†å“ˆå¸Œï¼š$officialHash"

          if ($downloadedHash -ne $officialHash) {
            echo "âŒ é”™è¯¯ï¼šå®‰è£…åŒ…æŸåï¼å“ˆå¸Œä¸åŒ¹é…"
            exit 1
          } else {
            echo "âœ… å“ˆå¸Œæ ¡éªŒé€šè¿‡ï¼Œå®‰è£…åŒ…å®Œæ•´"
          }

          echo "`n=== 4. ä¿®å¤æ–‡ä»¶æƒé™ï¼ˆé¿å…æ— æ³•æ‰§è¡Œï¼‰ ==="
          # èµ‹äºˆå®‰è£…åŒ…å¯æ‰§è¡Œæƒé™
          icacls "${{ env.LAUNCH4J_EXE_PATH }}" /grant "Users:(RX)" /T 2>&1 | Out-Null
          echo "âœ… å·²èµ‹äºˆå¯æ‰§è¡Œæƒé™"
        shell: pwsh

      - name: 5. é™é»˜å®‰è£…64ä½Launch4j
        id: get_launch4j
        run: |
          echo "=== é™é»˜å®‰è£… ==="
          # ç”¨Start-Processæ‰§è¡Œï¼Œç¡®ä¿æ— äº¤äº’ä¸”ç­‰å¾…å®Œæˆ
          $process = Start-Process -FilePath "${{ env.LAUNCH4J_EXE_PATH }}" `
            -ArgumentList "/S" -Wait -NoNewWindow -PassThru -RedirectStandardError "./install_err.log"

          if ($process.ExitCode -ne 0) {
            echo "âŒ å®‰è£…å¤±è´¥ï¼é”™è¯¯æ—¥å¿—ï¼š"
            Get-Content "./install_err.log"
            exit 1
          }

          # éªŒè¯å®‰è£…ç»“æœ
          $launch4jPath = "C:\Program Files\launch4j\launch4j.exe"
          if (Test-Path $launch4jPath) {
            echo "âœ… å®‰è£…æˆåŠŸï¼š$launch4jPath"
            echo "launch4j_path=$launch4jPath" >> $env:GITHUB_OUTPUT
          } else {
            echo "âŒ æœªæ‰¾åˆ°å®‰è£…è·¯å¾„ï¼Œæœç´¢å¤‡é€‰ä½ç½®ï¼š"
            $altPath = Get-ChildItem -Path C:\ -Filter "launch4j.exe" -Recurse -Depth 3 | Select-Object -First 1
            if ($altPath) {
              echo "âœ… æ‰¾åˆ°å¤‡é€‰è·¯å¾„ï¼š$($altPath.FullName)"
              echo "launch4j_path=$($altPath.FullName)" >> $env:GITHUB_OUTPUT
            } else {
              exit 1
            }
          }
        shell: pwsh

      - name: 6. ç”ŸæˆXMLé…ç½®
        run: |
          $config = @"
          <?xml version="1.0" encoding="UTF-8"?>
          <launch4jConfig>
            <dontWrapJar>false</dontWrapJar>
            <jarPath>${{ env.JAR_FULL_PATH }}</jarPath>
            <outfile>${{ env.EXE_FULL_PATH }}</outfile>
            <platform>win64</platform>
            <jre>
              <path>${{ steps.get_jre.outputs.jre_escaped }}</path>
              <minVersion>21</minVersion>
            </jre>
            <mainClass>${{ env.MAIN_CLASS }}</mainClass>
          </launch4jConfig>
          "@
          $config | Set-Content "${{ env.LAUNCH4J_CONFIG }}" -Encoding UTF8
        shell: pwsh

      - name: 7. ç”ŸæˆEXEå¹¶éªŒè¯
        run: |
          $launch4j = "${{ steps.get_launch4j.outputs.launch4j_path }}"
          $process = Start-Process -FilePath $launch4j `
            -ArgumentList "${{ env.LAUNCH4J_CONFIG }}" -Wait -NoNewWindow -PassThru `
            -RedirectStandardOutput "./out.log" -RedirectStandardError "./err.log"

          if ($process.ExitCode -ne 0) {
            echo "âŒ EXEç”Ÿæˆå¤±è´¥ï¼æ—¥å¿—ï¼š"
            Get-Content "./out.log"
            Get-Content "./err.log"
            exit 1
          }

          if (Test-Path "${{ env.EXE_FULL_PATH }}") {
            echo "`nğŸ‰ æœ€ç»ˆæˆåŠŸï¼EXEè·¯å¾„ï¼š${{ env.EXE_FULL_PATH }}"
          } else {
            echo "âŒ EXEæœªç”Ÿæˆ"
            exit 1
          }
        shell: pwsh

      - name: 8. ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: mc-plugin-tool-final
          path: |
            ${{ env.JAR_FULL_PATH }}
            ${{ env.EXE_FULL_PATH }}