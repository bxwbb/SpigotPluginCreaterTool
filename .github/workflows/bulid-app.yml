name: æ„å»ºJaråŒ…å’ŒWindowså¯æ‰§è¡Œç¨‹åºï¼ˆæ— ä¸‹è½½ä¾èµ–ç‰ˆï¼‰

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  release:
    types: [ published ]

jobs:
  build:
    runs-on: windows-latest
    env:
      # æ ¸å¿ƒè·¯å¾„ï¼ˆå·²éªŒè¯æ­£ç¡®ï¼‰
      JAR_FULL_PATH: "./target/SpigotPluginCreaterTool.jar"  # assemblyç”Ÿæˆçš„Jar
      EXE_DIR: "./target/exe-win64"
      EXE_FULL_PATH: "./target/exe-win64/mc-plugin-tool.exe"
      LAUNCH4J_CONFIG: "./launch4j.xml"
      MAIN_CLASS: "org.bxwbb.spigotplugincreatertool.HelloApplication"
      TIMEOUT_SECONDS: 180  # 3åˆ†é’Ÿè¶…æ—¶

    steps:
      - name: 1. æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: 2. å®‰è£…Chocolateyï¼ˆç¡®ä¿æœ€æ–°ï¼‰
        run: |
          # å‡çº§Chocolateyåˆ°æœ€æ–°ç‰ˆï¼Œé¿å…æ—§ç‰ˆæœ¬å®‰è£…åŒ…é—®é¢˜
          if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
            Set-ExecutionPolicy Bypass -Scope Process -Force
            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
            Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          }
          choco upgrade chocolatey -y
        shell: pwsh

      - name: 3. è®¾ç½®64ä½JDK 21ï¼ˆè·å–å¹¶è½¬ä¹‰JREè·¯å¾„ï¼‰
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
          architecture: x64
      - id: get_jre
        run: |
          # 1. ç¡®è®¤è¶…æ—¶å˜é‡æœ‰æ•ˆ
          echo "âœ… è¶…æ—¶æ—¶é—´ï¼š${{ env.TIMEOUT_SECONDS }}ç§’"
          if (-not ${{ env.TIMEOUT_SECONDS }}) { exit 1 }

          # 2. è·å–JREè·¯å¾„ï¼ˆTemurin JDKå†…ç½®JREï¼‰
          $jreRawPath = if (Test-Path "$env:JAVA_HOME/jre") { "$env:JAVA_HOME/jre" } else { "$env:JAVA_HOME" }
          # è½¬ä¹‰è·¯å¾„ï¼ˆXMLä¸­éœ€ç”¨\\ä»£æ›¿\ï¼‰
          $jreEscapedPath = $jreRawPath -replace "\\", "\\\\"
          echo "jre_escaped=$jreEscapedPath" >> $env:GITHUB_OUTPUT
          echo "âœ… JREåŸå§‹è·¯å¾„ï¼š$jreRawPath"
          echo "âœ… JREè½¬ä¹‰è·¯å¾„ï¼š$jreEscapedPath"

          # 3. éªŒè¯JREå¯æ‰§è¡Œï¼ˆç¡®ä¿èƒ½æ‰¾åˆ°java.exeï¼‰
          $javaExePath = Join-Path $jreRawPath "bin/java.exe"
          if (Test-Path $javaExePath) {
            echo "âœ… Java.exeå­˜åœ¨ï¼š$javaExePath"
            & $javaExePath -version  # è¾“å‡ºJavaç‰ˆæœ¬ï¼Œç¡®è®¤å¯ç”¨
          } else {
            echo "âŒ é”™è¯¯ï¼šJREè·¯å¾„ä¸‹æ— java.exeï¼"
            exit 1
          }
        shell: pwsh

      - name: 4. æ„å»ºJaråŒ…ï¼ˆæœ€ç»ˆéªŒè¯ï¼‰
        run: |
          echo "=== æ‰§è¡ŒMavenæ‰“åŒ… ==="
          mvn clean package -DskipTests -U

          echo "`n=== éªŒè¯JaråŒ…å®Œæ•´æ€§ ==="
          # æ£€æŸ¥JaråŒ…æ˜¯å¦å­˜åœ¨ä¸”å¤§å°æ­£å¸¸ï¼ˆé¿å…ç©ºåŒ…ï¼‰
          if (-not (Test-Path "${{ env.JAR_FULL_PATH }}")) {
            echo "âŒ é”™è¯¯ï¼šJaråŒ…ä¸å­˜åœ¨ï¼è·¯å¾„ï¼š${{ env.JAR_FULL_PATH }}"
            exit 1
          }
          $jarSize = (Get-Item "${{ env.JAR_FULL_PATH }}").Length / 1024
          if ($jarSize -lt 100) {  # å°äº100KBè§†ä¸ºå¼‚å¸¸
            echo "âŒ é”™è¯¯ï¼šJaråŒ…è¿‡å°ï¼ˆ$jarSize KBï¼‰ï¼Œå¯èƒ½æŸåï¼"
            exit 1
          }

          # éªŒè¯ä¸»ç±»æ˜¯å¦åœ¨JaråŒ…ä¸­
          echo "`n=== éªŒè¯ä¸»ç±» ==="
          $mainClassInJar = "${{ env.MAIN_CLASS }}".Replace('.', '/') + ".class"
          $mainClassExists = jar tf "${{ env.JAR_FULL_PATH }}" | Select-String -Pattern "$mainClassInJar"
          if ($mainClassExists) {
            echo "âœ… ä¸»ç±»å­˜åœ¨ï¼š$mainClassInJar"
          } else {
            echo "âŒ é”™è¯¯ï¼šä¸»ç±»ä¸åœ¨JaråŒ…ä¸­ï¼"
            exit 1
          }
        shell: pwsh

      - name: 5. å®‰è£…32ä½Launch4jï¼ˆChocolateyï¼Œç¨³å®šæ— ä¸‹è½½ï¼‰
        id: find_launch4j
        run: |
          echo "=== å®‰è£…Launch4jï¼ˆChocolateyç¨³å®šç‰ˆï¼‰ ==="
          # å®‰è£…å¹¶å¼ºåˆ¶è¦†ç›–æ—§ç‰ˆæœ¬
          choco install launch4j -y --force --no-progress

          echo "`n=== å®šä½Launch4jè·¯å¾„ ==="
          # 32ä½Launch4jé»˜è®¤å®‰è£…è·¯å¾„ï¼ˆChocolateyå·²éªŒè¯ï¼‰
          $launch4jPath = "C:\Program Files (x86)\launch4j\launch4j.exe"
          if (Test-Path $launch4jPath) {
            echo "âœ… æ‰¾åˆ°32ä½Launch4jï¼š$launch4jPath"
            # éªŒè¯å·¥å…·å¯æ‰§è¡Œï¼ˆè¾“å‡ºç‰ˆæœ¬ï¼‰
            & $launch4jPath --version
            echo "launch4j_path=$launch4jPath" >> $env:GITHUB_OUTPUT
          } else {
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°Launch4jï¼æœç´¢å¤‡é€‰è·¯å¾„ï¼š"
            $altPath = Get-ChildItem -Path C:\ -Filter "launch4j.exe" -Recurse -Depth 3 | Select-Object -First 1
            if ($altPath) {
              echo "âœ… æ‰¾åˆ°å¤‡é€‰è·¯å¾„ï¼š$($altPath.FullName)"
              echo "launch4j_path=$($altPath.FullName)" >> $env:GITHUB_OUTPUT
            } else {
              exit 1
            }
          }
        shell: pwsh

      - name: 6. ç”ŸæˆXMLé…ç½®ï¼ˆæ— é”™è¯¯+JREç¡¬ç¼–ç ï¼‰
        run: |
          echo "=== ç”ŸæˆLaunch4jé…ç½®æ–‡ä»¶ ==="
          # æ ¸å¿ƒï¼šç¡¬ç¼–ç è½¬ä¹‰åçš„JREè·¯å¾„ï¼Œé¿å…å·¥å…·æŸ¥æ‰¾JREå¡ä½
          $configContent = @"
          <?xml version="1.0" encoding="UTF-8"?>
          <launch4jConfig>
            <dontWrapJar>false</dontWrapJar>
            <!-- JaråŒ…è·¯å¾„ï¼šç›¸å¯¹è·¯å¾„ï¼Œæ— éœ€è½¬ä¹‰ -->
            <jarPath>${{ env.JAR_FULL_PATH }}</jarPath>
            <!-- EXEè¾“å‡ºè·¯å¾„ï¼šè‹±æ–‡è·¯å¾„ï¼Œé¿å…ç¼–ç é—®é¢˜ -->
            <outfile>${{ env.EXE_FULL_PATH }}</outfile>
            <!-- å¼ºåˆ¶ç”Ÿæˆ64ä½EXEï¼ˆä¸å·¥å…·ä½æ•°æ— å…³ï¼‰ -->
            <platform>win64</platform>
            <!-- å…³é”®ï¼šç¡¬ç¼–ç JREè·¯å¾„ï¼Œè§£å†³æ‰¾ä¸åˆ°JREçš„æ ¸å¿ƒé—®é¢˜ -->
            <jre>
              <path>${{ steps.get_jre.outputs.jre_escaped }}</path>
              <minVersion>21</minVersion>
              <maxVersion>21</maxVersion>  <!-- é™åˆ¶JREç‰ˆæœ¬ï¼Œé¿å…å…¼å®¹é—®é¢˜ -->
              <jdkPreference>preferJre</jdkPreference>
            </jre>
            <!-- ä¸»ç±»ï¼šä¸JaråŒ…ä¸­éªŒè¯çš„è·¯å¾„ä¸€è‡´ -->
            <mainClass>${{ env.MAIN_CLASS }}</mainClass>
            <!-- ç®€åŒ–é…ç½®ï¼Œç§»é™¤æ‰€æœ‰éå¿…è¦é¡¹ï¼Œå‡å°‘è§£æè´Ÿæ‹… -->
            <manifest></manifest>
            <classPath></classPath>
            <icon></icon>
          </launch4jConfig>
          "@

          # å†™å…¥é…ç½®æ–‡ä»¶ï¼ˆç¡®ä¿UTF-8ç¼–ç ï¼‰
          $configContent | Set-Content "${{ env.LAUNCH4J_CONFIG }}" -Encoding UTF8
          echo "âœ… é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
          echo "`næœ€ç»ˆé…ç½®å†…å®¹ï¼ˆå…³é”®éƒ¨åˆ†ï¼‰ï¼š"
          Select-String -Path "${{ env.LAUNCH4J_CONFIG }}" -Pattern '<jarPath>|<outfile>|<platform>|<jre>|<mainClass>'
        shell: pwsh

      - name: 7. ç”Ÿæˆ64ä½EXEï¼ˆè¶…æ—¶ç›‘æ§+æ—¥å¿—æ•è·ï¼‰
        run: |
          $launch4jPath = "${{ steps.find_launch4j.outputs.launch4j_path }}"
          $timeout = [int]${{ env.TIMEOUT_SECONDS }}
          $elapsed = 0

          echo "=== å¯åŠ¨Launch4jï¼ˆç”Ÿæˆ64ä½EXEï¼‰ ==="
          echo "å·¥å…·è·¯å¾„ï¼š$launch4jPath"
          echo "é…ç½®æ–‡ä»¶ï¼š${{ env.LAUNCH4J_CONFIG }}"
          echo "è¾“å‡ºè·¯å¾„ï¼š${{ env.EXE_FULL_PATH }}"

          # å¯åŠ¨Launch4jå¹¶æ•è·åŒè¾“å‡ºæµï¼ˆé”™è¯¯æ—¥å¿—å…³é”®ï¼‰
          $process = Start-Process -FilePath $launch4jPath `
            -ArgumentList "${{ env.LAUNCH4J_CONFIG }}" `
            -NoNewWindow `
            -PassThru `
            -RedirectStandardOutput "./launch4j_out.log" `
            -RedirectStandardError "./launch4j_err.log"

          # å®æ—¶ç›‘æ§è¿›ç¨‹çŠ¶æ€ï¼ˆæ¯5ç§’ä¸€æ¬¡ï¼Œçµæ•æ•æ‰å¼‚å¸¸ï¼‰
          while (-not $process.HasExited -and $elapsed -lt $timeout) {
            Start-Sleep -Seconds 5
            $elapsed += 5
            $remaining = $timeout - $elapsed

            # è¾“å‡ºèµ„æºå ç”¨ï¼ˆåˆ¤æ–­æ˜¯å¦å¡ä½ï¼‰
            $cpu = (Get-Counter "\Process(launch4j*)\% Processor Time" -ErrorAction SilentlyContinue).CounterSamples.CookedValue
            $mem = (Get-Counter "\Process(launch4j*)\Working Set - Private" -ErrorAction SilentlyContinue).CounterSamples.CookedValue / 1MB
            echo "å·²è¿è¡Œ$elapsedç§’ | å‰©ä½™$remainingç§’ | CPU: $($cpu.ToString('N2'))% | å†…å­˜: $($mem.ToString('N2'))MB"
          }

          # å¤„ç†è¿›ç¨‹ç»“æœ
          if (-not $process.HasExited) {
            echo "`nâŒ è¶…æ—¶ï¼Launch4jè¿è¡Œè¶…è¿‡$timeoutç§’ï¼Œå¼ºåˆ¶ç»ˆæ­¢"
            $process | Stop-Process -Force
            exit 1
          } else {
            echo "`nâœ… Launch4jæ­£å¸¸é€€å‡ºï¼Œé€€å‡ºç ï¼š$($process.ExitCode)"

            # è¾“å‡ºå®Œæ•´æ—¥å¿—ï¼ˆæ— è®ºæˆåŠŸå¤±è´¥ï¼Œä¾¿äºæ’æŸ¥ï¼‰
            echo "`n=== æ ‡å‡†è¾“å‡ºæ—¥å¿— ==="
            if (Test-Path "./launch4j_out.log") { Get-Content "./launch4j_out.log" } else { echo "æ— æ—¥å¿—" }

            echo "`n=== é”™è¯¯è¾“å‡ºæ—¥å¿— ==="
            if (Test-Path "./launch4j_err.log") { Get-Content "./launch4j_err.log" } else { echo "æ— æ—¥å¿—" }

            # é€€å‡ºç é0åˆ™å¤±è´¥
            if ($process.ExitCode -ne 0) {
              echo "`nâŒ EXEç”Ÿæˆå¤±è´¥ï¼é€€å‡ºç é0"
              exit 1
            }
          }

          # æœ€ç»ˆéªŒè¯EXEæ˜¯å¦ç”Ÿæˆ
          echo "`n=== éªŒè¯EXEäº§ç‰© ==="
          if (Test-Path "${{ env.EXE_FULL_PATH }}") {
            $exeSize = (Get-Item "${{ env.EXE_FULL_PATH }}").Length / 1024
            echo "ğŸ‰ æˆåŠŸï¼64ä½EXEç”Ÿæˆå®Œæˆ"
            echo "EXEè·¯å¾„ï¼š${{ env.EXE_FULL_PATH }}"
            echo "EXEå¤§å°ï¼š$exeSize KB"
          } else {
            echo "âŒ å¤±è´¥ï¼EXEæ–‡ä»¶æœªæ‰¾åˆ°"
            exit 1
          }
        shell: pwsh

      - name: 8. ä¸Šä¼ æœ€ç»ˆäº§ç‰©ï¼ˆJar+EXEï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: mc-plugin-tool-final
          path: |
            ${{ env.JAR_FULL_PATH }}
            ${{ env.EXE_FULL_PATH }}
          if-no-files-found: error  # æ— æ–‡ä»¶ç›´æ¥æŠ¥é”™ï¼Œé¿å…ç©ºäº§ç‰©