name: 构建Jar包和Windows可执行程序

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  release:
    types: [ published ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      - name: 设置JDK 21（64位）
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: 构建可执行Jar包（强制更新依赖）
        run: mvn clean package -DskipTests -U
        shell: pwsh

      - name: 安装Launch4j
        run: |
          # 安装launch4j（Chocolatey默认会安装到C:\ProgramData\chocolatey\bin）
          choco install launch4j -y
          # 输出安装路径（确认位置）
          echo "Launch4j默认安装路径: C:\ProgramData\chocolatey\bin\launch4j.exe"
        shell: pwsh

      - name: 验证Launch4j安装（命令+绝对路径双检查）
        run: |
          echo "=== 验证命令调用 ==="
          try {
            launch4j --version
            echo "命令调用成功"
          } catch {
            echo "命令调用失败（可能环境变量未刷新）"
          }

          echo "`n=== 验证绝对路径调用 ==="
          $launch4jExePath = "C:\ProgramData\chocolatey\bin\launch4j.exe"
          if (Test-Path $launch4jExePath) {
            & $launch4jExePath --version
            echo "绝对路径调用成功"
          } else {
            echo "错误：未找到 $launch4jExePath"
            # 搜索可能的路径（辅助排查）
            Get-ChildItem -Path C:\ -Filter launch4j.exe -Recurse -ErrorAction SilentlyContinue | Select-Object FullName
            exit 1
          }
        shell: pwsh

      - name: 创建EXE输出目录
        run: |
          New-Item -ItemType Directory -Path ./target/exe-win64 -Force
        shell: pwsh

      - name: 生成Windows 64位EXE程序（使用绝对路径）
        run: |
          # 明确使用Chocolatey安装的绝对路径，避免环境变量问题
          $launch4jExePath = "C:\ProgramData\chocolatey\bin\launch4j.exe"
          echo "使用绝对路径生成EXE: $launch4jExePath"
          & $launch4jExePath ./launch4j.xml
        shell: pwsh

      - name: 上传Jar包产物
        uses: actions/upload-artifact@v4
        with:
          name: mc-plugin-tool-jar
          path: ./target/*.jar

      - name: 上传Windows EXE产物
        uses: actions/upload-artifact@v4
        with:
          name: mc-plugin-tool-windows
          path: ./target/exe-win64/*.exe