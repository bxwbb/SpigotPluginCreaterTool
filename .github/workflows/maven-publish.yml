name: Maven Build + JWrapper EXE
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-package:
    runs-on: ubuntu-latest # JWrapper 可在 Linux 下跨平台打包 Windows exe
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      # 步骤1：安装 Java 21（构建 Jar 包用）
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 步骤2：构建可执行 Jar 包
      - name: Build Jar with Maven
        run: mvn -B clean package --file pom.xml

      # 步骤3：下载 JWrapper 工具
      - name: Download JWrapper
        run: wget https://www.jwrapper.com/download/JWrapper.jar -O ./JWrapper.jar

      # 步骤4：准备 JWrapper 配置文件（直接在工作流中生成，避免本地文件上传）
      - name: Create JWrapper config.xml
        run: |
          cat > ./config.xml << EOF
          <JWrapper>
              <AppName>SpigotPluginCreaterTool</AppName>
              <AppVersion>0.0.2</AppVersion>
              <MainClass>org.bxwbb.spigotplugincreatertool.HelloApplication</MainClass>
              <IncludeJRE>true</IncludeJRE>
              <JREVersion>21</JREVersion>
              <JREDownloadURL>https://javadl.oracle.com/webapps/download/AutoDL?BundleId=249194_424b9da4b48848379167015dcc250d8d</JREDownloadURL>
              <JarPath>./target/SpigotPluginCreaterTool-0.0.2.jar</JarPath>
              <Windows>
                  <EXEName>SpigotPluginCreaterTool.exe</EXEName>
                  <AdminRequired>false</AdminRequired>
              </Windows>
              <OutputDir>./jwrapper-output</OutputDir>
          </JWrapper>
          EOF

      # 步骤5：用 JWrapper 打包 exe
      - name: Package EXE with JWrapper
        run: java -jar JWrapper.jar ./config.xml

      # 步骤6：上传所有产物（Jar压缩包、单个Jar、exe）
      - name: Upload All Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: SpigotPluginCreaterTool-All-Products
          path: |
            ./target/*.jar                # 所有 Jar 包
            ./jwrapper-output/Windows/*.exe # 生成的 exe 文件
          if-no-files-found: error